<script>
    const sndCorrect = new Audio('https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3');
    const sndWrong = new Audio('https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3');

    const words = [
        {r:"ØµØ§Ø¨ÙˆÙ†", w:"Ø³Ø§Ø¨ÙˆÙ†"}, {r:"Ø­ÛŒØ§Ø·", w:"Ø­ÛŒØ§Øª"}, {r:"Ù‚ÙˆØ±Ø¨Ø§ØºÙ‡", w:"ØºÙˆØ±Ø¨Ø§ØºÙ‡"}, {r:"Ø·Ù†Ø§Ø¨", w:"ØªÙ†Ø§Ø¨"},
        {r:"Ø®ÙˆØ±Ø´ÛŒØ¯", w:"Ø®ÙØ±Ø´ÛŒØ¯"}, {r:"Ø¹ÛŒÙ†Ú©", w:"Ø§ÛŒÙ†Ú©"}, {r:"Ø°Ø±Øª", w:"Ø²Ø±Øª"}, {r:"Ø«Ø§Ù†ÛŒÙ‡", w:"Ø³Ø§Ù†ÛŒÙ‡"},
        {r:"ØªÙ…ÛŒØ²", w:"Ø·Ù…ÛŒØ²"}, {r:"Ø®ÙˆØ§Ø¨", w:"Ø®ÙˆØ§Ø¨"}, {r:"Ø®ÙˆØ§Ù‡Ø±", w:"Ø®Ø§Ù‡Ø±"}, {r:"ØµØ¯Ø§", w:"Ø³Ø¯Ø§"},
        {r:"Ù…Ø±Øº", w:"Ù…ÙˆØ±Øº"}, {r:"ØµØ¨Ø­", w:"Ø³Ø¨Ø­"}, {r:"Ù„Ø·Ù", w:"Ù„ØªÙ"}, {r:"Ø­ÙˆØ¶", w:"Ù‡ÙˆØ¶"},
        {r:"ØªØµÙ…ÛŒÙ…", w:"ØªØ³Ù…ÛŒÙ…"}, {r:"Ø¹Ø²ÛŒØ²", w:"Ø§Ø²ÛŒØ²"}, {r:"Ø³Ø§Ø¹Øª", w:"ØµØ§Ø¹Øª"}, {r:"Ù‚Ø·Ø±Ù‡", w:"Ù‚ØªØ±Ù‡"},
        {r:"Ù…Ø®ØµÙˆØµ", w:"Ù…Ø®ØµÙˆØ³"}, {r:"Ø§Ù…ØªØ­Ø§Ù†", w:"Ø§Ù…ØªØ®Ø§Ù†"}, {r:"Ø§Ø°ÛŒØª", w:"Ø§Ø²ÛŒØª"}, {r:"Ú©Ø«ÛŒÙ", w:"Ú©ØµÛŒÙ"},
        {r:"Ø¶Ø±Ø±", w:"Ø²Ø±Ø±"}, {r:"Ø¨Ø§Ø¹Ø«", w:"Ø¨Ø§Ø¹Ø«"}, {r:"Ù†Ù‚Ø·Ù‡", w:"Ù†Ù‚ØªÙ‡"}, {r:"Ø­ÙˆÙ„Ù‡", w:"Ù‡ÙˆÙ„Ù‡"},
        {r:"Ø´Ø¬Ø§Ø¹", w:"Ø´Ø¬Ø§"}, {r:"Ø¹Ø³Ù„", w:"Ø§Ø³Ù„"}, {r:"ØºØµÙ‡", w:"Ù‚ØµÙ‡"}, {r:"ØµÙ†Ø¯Ù„ÛŒ", w:"Ø³Ù†Ø¯Ù„ÛŒ"},
        {r:"ØªØ³Ø¨ÛŒØ­", w:"ØªØµØ¨ÛŒØ­"}, {r:"Ø¶Ù…ÛŒØ±", w:"Ø²Ù…ÛŒØ±"}, {r:"Ø­ÛŒÙˆØ§Ù†", w:"Ù‡ÛŒÙˆØ§Ù†"}, {r:"Ø®ÙˆØ´Ø­Ø§Ù„", w:"Ø®Ø´Ù‡Ø§Ù„"}
    ];

    let score = 0;
    let currentPair = {};
    let wrongQueue = [];

    // ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙ„ÙØ¸
    function speakCurrent() {
        if (!document.getElementById('mute-voice').checked) return;
        
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(currentPair.r);
        
        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¨Ù‡ØªØ±ÛŒÙ† ØµØ¯Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± Ø³ÛŒØ³ØªÙ…
        const voices = window.speechSynthesis.getVoices();
        const faVoice = voices.find(v => v.lang.includes('fa') || v.lang.includes('per'));
        if (faVoice) msg.voice = faVoice;

        msg.lang = 'fa-IR';
        msg.rate = 0.6; // Ø³Ø±Ø¹Øª Ø±Ø§ Ú©Ù…ÛŒ Ú©Ù…ØªØ± Ú©Ø±Ø¯ÛŒÙ… ØªØ§ ÙˆØ§Ø¶Ø­â€ŒØªØ± Ø´ÙˆØ¯
        msg.pitch = 1;
        window.speechSynthesis.speak(msg);
    }

    function initRound() {
        if (wrongQueue.length > 0 && Math.random() > 0.6) {
            currentPair = wrongQueue.shift();
        } else {
            currentPair = words[Math.floor(Math.random() * words.length)];
        }
        const flip = Math.random() > 0.5;
        document.getElementById('opt1').innerText = flip ? currentPair.r : currentPair.w;
        document.getElementById('opt2').innerText = flip ? currentPair.w : currentPair.r;
        document.getElementById('character').innerText = "ğŸ¤”";
        
        // Ø§Ø¬Ø±Ø§ÛŒ ØªÙ„ÙØ¸
        speakCurrent();
    }

    function handleSelect(btn) {
        if (!currentPair.r) return; // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ Ù‚Ø¨Ù„ Ø§Ø² Ø´Ø±ÙˆØ¹

        if (btn.innerText === currentPair.r) {
            score += 10;
            document.getElementById('character').innerText = "ğŸ¤©";
            if(document.getElementById('mute-sfx').checked) sndCorrect.play().catch(()=>{});
        } else {
            score = Math.max(0, score - 5);
            document.getElementById('character').innerText = "ğŸ˜Ÿ";
            if(document.getElementById('mute-sfx').checked) sndWrong.play().catch(()=>{});
            
            if (!currentPair.count) currentPair.count = 0;
            if (currentPair.count < 3) { 
                currentPair.count++; 
                wrongQueue.push({...currentPair}); 
            }
        }
        document.getElementById('score').innerText = score;
        setTimeout(initRound, 1000);
    }

    // Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø³ÛŒØ§Ø± Ù…Ù‡Ù… Ø§Ø³Øª: ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Ø§ÙˆÙ„ÛŒÙ† ØªØ¹Ø§Ù…Ù„
    window.addEventListener('click', function() {
        if (!currentPair.r) {
            initRound();
        }
    }, { once: true });

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
</script>
